{% macro sentencecase(text) %}
    {{- text[0]|upper}}{{text[1:] -}}
{% endmacro %}
{% macro init_members(NODE) %}
    {% for CHILD in NODE.children %}
    {% if TYPES.INT_VALUE in CHILD.type %}
        {% set python_type = 'int' %}
    {% elif TYPES.FLOAT_VALUE in CHILD.type %}
        {% set python_type = 'float' %}
    {% elif TYPES.VARLEN_STRING in CHILD.type %}
        {% set python_type = 'str' %}
    {% else %}
        {% set python_type = 'float' %}
    {% endif %}
    {% if TYPES.INDEXED_GROUP in CHILD.type %}
    self.{{- CHILD.name }} = {{ sentencecase(CHILD.name) }}(self._h, self._cfg)  # Indexed group
    {% else %}
    if '{{ CHILD.name }}' in self._h.keys():
    {% if TYPES.GROUP in CHILD.type %}
        self._{{- CHILD.name }} = {{ sentencecase(CHILD.name) }}(self._h['{{CHILD.name}}'].id, self._cfg)  # Group
    {% elif (TYPES.ARRAY_1D in CHILD.type) or (TYPES.ARRAY_2D in CHILD.type) %}
        if not self._cfg.dynamic_loading:
            self._{{- CHILD.name }} = np.array(self._h['{{CHILD.name}}']).astype({{ python_type }})  # Array
    {% elif TYPES.VARLEN_STRING in CHILD.type %}
        if not self._cfg.dynamic_loading:
            self._{{- CHILD.name }} = _read_string(self._h['{{ CHILD.name }}'])
    {% else %}
        if not self._cfg.dynamic_loading:
            self._{{- CHILD.name }} = {{ python_type }}(self._h['{{ CHILD.name }}'][()])
    {% endif %}
    {% if (TYPES.REQUIRED in CHILD.type) and not ((TYPES.REQUIRED + '1' in CHILD.type) or (TYPES.REQUIRED + '2' in CHILD.type)) %}
    else:
        warn(str(self.__class__.__name__) + ' missing required key ' + '"{{CHILD.name}}"')
    {% endif %}
    {% endif %}

    {% endfor %}
{% endmacro %}
{% macro gen_properties(NODE) %}
{% for CHILD in NODE.children %}
    {% if TYPES.INT_VALUE in CHILD.type %}
        {% set python_type = 'int' %}
    {% elif TYPES.FLOAT_VALUE in CHILD.type %}
        {% set python_type = 'float' %}
    {% elif TYPES.VARLEN_STRING in CHILD.type %}
        {% set python_type = 'str' %}
    {% else %}
        {% set python_type = 'float' %}
    {% endif %}
    @property
    def {{ CHILD.name }}(self):
    {% if TYPES.INDEXED_GROUP in CHILD.type %}
        return self._{{ CHILD.name }}
    {% elif TYPES.GROUP in CHILD.type %}
        if '{{ CHILD.name }}' in self._h.keys():
            return self._{{ CHILD.name }}
    {% else %}
        if self._cfg.dynamic_loading and self._{{ CHILD.name }} is None:
            if '{{ CHILD.name }}' in self._h.keys():
    {% if (TYPES.ARRAY_1D in CHILD.type) or (TYPES.ARRAY_2D in CHILD.type) %}
                return np.array(self._h['{{ CHILD.name }}']).astype({{ python_type }})  # Array
    {% elif TYPES.VARLEN_STRING in CHILD.type %}
                return _read_string(self._h['{{ CHILD.name }}'])
    {% else %}
                return {{ python_type }}(self._h['{{ CHILD.name }}'][()])
    {% endif %}
        return self._{{ CHILD.name }}
    {% endif %}

    @{{ CHILD.name }}.setter
    def {{ CHILD.name }}(self, value):
        self._{{ CHILD.name }} = value

    {% endfor %}
{% endmacro %}
{% macro gen_writer(NODE) %}
    def _save(self, *args):
{% for CHILD in NODE.children %}
    {% if TYPES.INT_VALUE in CHILD.type %}
        {% set h5_type = "'i4'" %}
    {% elif TYPES.FLOAT_VALUE in CHILD.type %}
        {% set h5_type = "'f8'" %}
    {% elif TYPES.VARLEN_STRING in CHILD.type %}
        {% set h5_type = "h5py.string_dtype(encoding='ascii', length=None)" %}
    {% else %}
        {% set h5_type = "'f8'" %}
    {% endif %}
    {% if (TYPES.GROUP in CHILD.type) or (TYPES.INDEXED_GROUP in CHILD.type) %}
        self.{{ CHILD.name }}._save()
    {% else %}
        if self._{{ CHILD.name }} is not None:
            del self._h['{{ CHILD.name }}']
    {% if (TYPES.ARRAY_1D in CHILD.type) or (TYPES.ARRAY_2D in CHILD.type) %}
            {% if TYPES.VARLEN_STRING in CHILD.type %}
            self._h.create_dataset('{{ CHILD.name }}', dtype={{ h5_type }}, data=np.array(self._{{ CHILD.name }}).astype('O'))
            {% else %}
            self._h.create_dataset('{{ CHILD.name }}', dtype={{ h5_type }}, data=np.array(self._{{ CHILD.name }}))
            {% endif %}
    {% elif TYPES.VARLEN_STRING in CHILD.type %}
            self._h.create_dataset('{{ CHILD.name }}', dtype={{ h5_type }}, data=self._{{ CHILD.name }})
    {% else %}
            self._h.create_dataset('{{ CHILD.name }}', dtype={{ h5_type }}, data=self._{{ CHILD.name }})

    {% endif %}
    {% endif %}
    {% endfor %}
{% endmacro %}
{{ BASE }}

# generated by {{ USER }} on {{ DATE }}
# version {{ VERSION }} SNIRF specification parsed from {{ SPEC_SRC }}


{% for GROUP in GROUPS %}
class {{ sentencecase(GROUP.name) -}}(_Group):

    {% for CHILD in GROUP.children %}
    _{{ CHILD.name }} = None  # {{ CHILD.type }}
    {% endfor %}

    def __init__(self, gid: h5py.h5g.GroupID, cfg: SnirfConfig):
        super().__init__(gid, cfg)
    {{ init_members(GROUP) | indent }}
{{ gen_properties(GROUP) }}
{{ gen_writer(GROUP) }}


{% endfor %}
{% for INDEXED_GROUP in INDEXED_GROUPS %}
class {{ sentencecase(INDEXED_GROUP.name) -}}Element(_Group):

    {% for CHILD in INDEXED_GROUP.children %}
    _{{ CHILD.name }} = None  # {{ CHILD.type }}
    {% endfor %}

    def __init__(self, gid: h5py.h5g.GroupID, cfg: SnirfConfig):
        super().__init__(gid, cfg)
    {{ init_members(INDEXED_GROUP) | indent }}
{{ gen_properties(INDEXED_GROUP) }}
{{ gen_writer(INDEXED_GROUP) }}

class {{ sentencecase(INDEXED_GROUP.name) -}}(_IndexedGroup):

    _name: str = '{{ INDEXED_GROUP.name }}'
    _element: _Group = {{ sentencecase(INDEXED_GROUP.name) -}}Element

    def __init__(self, h: h5py.File, cfg: SnirfConfig):
        super().__init__(h, cfg)


{% endfor %}
class Snirf():
    
    _name = '/'
    {% for CHILD in ROOT.children %}
    _{{ CHILD.name }} = None  # {{ CHILD.type }}
    {% endfor %}

    def __init__(self, path, dynamic_loading: bool = False):
        if type(path) is str:
            if not path.endswith('.snirf'):
                path = path.join('.snirf')
            if os.path.exists(path):
                self._h = h5py.File(path, 'r+')
            else:
                self._h = h5py.File(path, 'a')
            self._cfg = SnirfConfig()
            self._cfg.dynamic_loading = dynamic_loading
            self._cfg.filepath = path
        {{ init_members(ROOT) | indent(8) }}
        else:
            raise FileNotFoundError('Unable to find file: name =' + path)
{{ gen_properties(ROOT) }}
{{ gen_writer(ROOT) }}

    def save(self, *args):
        if len(args) > 0 and type(args[0]) is str:
            path = args[0]
            if not path.endswith('.snirf'):
                path.join('.snirf')
                new_file = h5py.File(path, 'w')
                self._save(path)
        else:
            self._save()

    def __del__(self):
        self._h.close()

    def __repr__(self):
        props = [p for p in dir(self) if ('_' not in p and not callable(getattr(self, p)))]
        out = str(self.__class__.__name__) + ' at ' + self._cfg.filepath + '\n'
        for prop in props:
            attr = getattr(self, prop)
            out += prop + ': '
            if type(attr) is np.ndarray or type(attr) is list:
                if np.size(attr) > 32:
                    out += '<' + str(np.shape(attr)) + ' array of ' + str(attr.dtype) + '>'
                else:
                    out += str(attr)
            else:
                prepr = str(attr)
                if len(prepr) < 64:
                    out += prepr
                else:
                    out += '\n' + prepr
            out += '\n'
        return out[:-1]
